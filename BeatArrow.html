<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF‑8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>WebGL Drum & Bass Rhythm Game</title>
<style>
html,body{margin:0;padding:0;width:100%;height:100%;overflow:hidden;background:#050712;color:#fff;font-family:system-ui;}
#canvas{position:absolute;inset:0;}
.panel{background:rgba(0,0,0,0.45);backdrop-filter:blur(6px);border-radius:12px;border:1px solid rgba(255,255,255,0.08);padding:8px;z-index:5;}
#top{position:fixed;top:10px;left:10px;right:10px;display:flex;gap:8px;flex-wrap:wrap;align-items:center;}
#hud{position:fixed;bottom:10px;left:10px;right:10px;display:flex;gap:12px;align-items:center;}
#judge{position:fixed;left:50%;top:45%;transform:translate(-50%,-50%);font-size:32px;font-weight:900;opacity:0;transition:.3s;pointer-events:none;}
.key{width:48px;height:48px;border-radius:12px;background:#1b2138;border:2px solid #2d3b66;display:flex;align-items:center;justify-content:center;font-weight:900;transition:.1s;}
.key.active{background:#3b7bff;border-color:#9ec5ff;box-shadow:0 0 14px #7db1ff;}
</style>
</head>
<body>

<div id="canvas"></div>

<div id="top" class="panel">
  <select id="level"></select>
  <select id="difficulty">
    <option value="easy">Easy</option><option value="normal">Normal</option><option value="hard">Hard</option>
  </select>
  <select id="environment"><option value="neon">Neon</option><option value="stellar">Stars</option></select>
  <button id="start">Start</button>
  <button id="pause" disabled>Pause</button>
  <button id="restart" disabled>Restart</button>
  <input id="vol" type="range" min="0" max="1" step="0.01" value="0.8">
</div>

<div id="hud" class="panel">
  <div id="score">Score 0</div>
  <div id="combo">Combo 0</div>
  <div id="acc">Acc 100%</div>
</div>

<div id="judge">READY</div>

<div id="keys" style="position:fixed;bottom:80px;left:50%;transform:translateX(-50%);display:flex;gap:12px;">
  <div class="key" id="kA">A</div><div class="key" id="kS">S</div>
  <div class="key" id="kD">D</div><div class="key" id="kF">F</div>
</div>

<script src="https://unpkg.com/three@0.159.0/build/three.min.js"></script>
<script>
(() => {
'use strict';

/* ================= SETTINGS ================= */
const LANES = ['A','S','D','F'], X = {A:-6,S:-2,D:2,F:6};
const SPAWN=-80, TARGET=-5, APPROACH=2;
const WINDOWS = {perfect:0.045,great:0.09,good:0.15,miss:0.21};

/* ===== SHORT BASE64 DRUM & BASS LOOP ===== */
/* (8‑second drum loop encoded as MP3) */
const BASE64_MP3_LOOP =
  "data:audio/mp3;base64," +
  "SUQzBAAAAAAAI1RTU0UAAAAPAAADTGF2ZjU2LjM2LjEwMAAAAAAAAAAAAAAA//tQxAADBZWFz" +
  "ZGlyZWNvZGUAAAAAAExBTkYAAAACAAADSAAAAAEASAAA/9sAQwAEBAMFBAMFBQUGBwwGCQgHBwcH" +
  "CQsKCgsKCgsMCwwMDAwODg4QDw8PDxAPEA8QEBAPDw8PEA8PDxAPDw8PDxAPDw8PDxAPDw//sQxA" +
  "ADBZWFzZGVy… (TRUNCATED for brevity — embed full base64 audio)";

/* =============== GAME STATE =============== */
const LEVELS = [
  {name:'Bass Intro', bpm:120, notes:[]},
  {name:'Neon Groove', bpm:140, notes:[]},
  {name:'Star Drift', bpm:160, notes:[]},
  {name:'Pulse Ride', bpm:175, notes:[]},
  {name:'Final Break', bpm:180, notes:[]}
];

function generatePattern(bpm, count, step) {
  const out=[]; const spb = 60/bpm;
  let beat = 2;
  for(let i=0;i<count;i++){
    const lane = LANES[Math.floor(Math.random()*LANES.length)];
    out.push({time:beat*spb,lane});
    beat += step;
  }
  return out;
}
LEVELS.forEach(l=>{l.notes = generatePattern(l.bpm, 80, 0.5);});

/* =============== SCENE =============== */
let renderer,scene,camera,clock;
let arrows=[],pool=[],laneMeshes={},hitRings=[];
let running=false,paused=false,score=0,combo=0,bestCombo=0,hitCount=0,judged=0,notes=[],health=1;
let currentLevelIndex=0,currentDiffKey='easy',currentEnv='neon';

function initScene(){
  renderer=new THREE.WebGLRenderer({antialias:true});
  renderer.setSize(window.innerWidth,window.innerHeight);
  document.getElementById('canvas').appendChild(renderer.domElement);

  scene=new THREE.Scene();
  camera=new THREE.PerspectiveCamera(65,window.innerWidth/window.innerHeight,0.1,400);
  camera.position.set(0,7,16);camera.lookAt(0,0,-15);
  clock=new THREE.Clock();

  const amb=new THREE.AmbientLight(0x404060,0.8);
  scene.add(amb);

  // ground
  const ground=new THREE.Mesh(new THREE.PlaneGeometry(200,200),
    new THREE.MeshPhongMaterial({color:0x15182f}));
  ground.rotation.x=-Math.PI/2;
  ground.position.y=-1.6;
  scene.add(ground);

  // lanes
  for(const l of LANES){
    const lane=new THREE.Mesh(
      new THREE.BoxGeometry(3.6,0.3,90),
      new THREE.MeshPhongMaterial({color:COLORS[l]||0xffffff})
    );
    lane.position.set(X[l],-1.4,-40);
    laneMeshes[l]=lane;
    scene.add(lane);

    const ring=new THREE.Mesh(
      new THREE.TorusGeometry(1.1,0.16,16,32),
      new THREE.MeshPhongMaterial({emissive:0x6ea8ff,shininess:80})
    );
    ring.position.set(X[l],0,TARGET);
    ring.rotation.x=Math.PI/2;
    hitRings.push(ring);
    scene.add(ring);
  }

  // arrow pool
  const arrowGeo=new THREE.ConeGeometry(1.1,3.2,16);
  for(let i=0;i<120;i++){
    const m=new THREE.Mesh(arrowGeo,new THREE.MeshPhongMaterial({color:0xffffff}));
    m.visible=false;
    scene.add(m);
    pool.push(m);
  }

  window.addEventListener('resize',()=>{camera.aspect=window.innerWidth/window.innerHeight;camera.updateProjectionMatrix();renderer.setSize(window.innerWidth,window.innerHeight);});
}
initScene();

/* =============== AUDIO =============== */
const AudioManager={
  audio:new Audio(BASE64_MP3_LOOP),
  play(){this.audio.currentTime=0;this.audio.play()},
  pause(){this.audio.pause()},
  resume(){this.audio.play()},
  stop(){this.audio.pause();this.audio.currentTime=0},
  getTime(){return this.audio.currentTime}
};

/* =============== GAME LOOP =============== */
function spawnArrow(note){
  const m=pool.find(p=>!p.visible);
  if(!m)return;
  m.visible=true;
  m.position.set(X[note.lane],0,SPAWN);
  m.userData={lane:note.lane,time:note.time,judged:false};
  arrows.push(m);
}
function updateArrows(dt){
  const speed=Math.abs(SPAWN-TARGET)/APPROACH;
  for(let i=arrows.length-1;i>=0;i--){
    const a=arrows[i];
    a.position.z+=speed*dt;
    if(a.position.z>TARGET+2 && !a.userData.judged){
      a.userData.judged=true;
      arrows.splice(i,1);
      pool.push(a);
      combo=0;judged++;health-=0.1;
    }
  }
}
function loop(){
  const dt=clock.getDelta();
  if(running&&!paused){
    const t=AudioManager.getTime();
    while(notes.length && notes[0].time<=t+APPROACH){
      spawnArrow(notes.shift());
    }
    updateArrows(dt);
  }
  renderer.render(scene,camera);
  requestAnimationFrame(loop);
}
loop();

/* =============== INPUT =============== */
document.addEventListener('keydown',e=>{
  const m={KeyA:'A',KeyS:'S',KeyD:'D',KeyF:'F'}[e.code];
  if(!m||!running||paused)return;
  keyEls[m].classList.add('active');
  const t=AudioManager.getTime();
  for(let i=0;i<arrows.length;i++){
    const a=arrows[i];
    if(a.userData.lane===m&&!a.userData.judged){
      const d=Math.abs(a.position.z-TARGET);
      if(d<=WINDOWS.miss){
        a.userData.judged=true;arrows.splice(i,1);pool.push(a);
        judged++;hitCount++;
      }
    }
  }
});
document.addEventListener('keyup',e=>{const m={KeyA:'A',KeyS:'S',KeyD:'D',KeyF:'F'}[e.code];if(m)keyEls[m].classList.remove('active');});

/* =============== UI =============== */
LEVELS.forEach((lvl,i)=>{const o=document.createElement('option');o.value=i;o.textContent=lvl.name;levelSel.appendChild(o);});
el('start').onclick=()=>{notes=LEVELS[currentLevelIndex].notes.slice();running=true;AudioManager.play();};
el('pause').onclick=()=>{paused=!paused;(paused?AudioManager.pause():AudioManager.resume());};
el('restart').onclick=()=>{runnerunning=false;notes=LEVELS[currentLevelIndex].notes.slice();AudioManager.play();running=true;};

})();
</script>

</body>
</html>
